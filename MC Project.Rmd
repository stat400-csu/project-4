---
title: "STAT 400 | Group 4 | Monte Carlo Simulation: CIED Longevity" 
output: html_document
---


```{r setup, include=FALSE}
library(tidyverse)     
library(knitr)         
library(kableExtra)    

set.seed(400) 

```


## Article 

Cardiac implantable electronic devices’ longevity: A novel modelling tool for estimation and comparison  

## Project Overview

### Introduction

This project replicates and extends the Monte Carlo simulation from Defaye et al. (2025) on Cardiac Implantable Electronic Device (CIED) longevity. The original study introduced a Power Consumption Index (PCI) model to standardize battery life predictions across different pacemaker models and manufacturers.

### Research Goals
1. Replicate the PCI model and Monte Carlo simulation methodology

2. Extend the model by incorporating greater physiological variability in lead impedance

3. Compare device longevity predictions under base and extended scenarios

### Power Consumption Index Model

**Model Definition**

The core PCI model from the original study is defined as:

**PCI** = t × I / C

Where:


**t** = Time in minutes

**I** = Total current drain (µA)

**C** = Battery capacity (Ah)

### Methods 

To recreate the Monte Carlo simulation from the study by generating a large group of 100,000 simulated patients in R. Within each iteration, we can randomly sample patient parameters (Conditions, Atrial Pacing Percentage, and Ventricular Pacing Percentage) and device parameters (Ventricular lead parameters, Atrial lead parameters, and Left ventricular parameters). All of these inputs are used to estimate the pacing related current (I in model). We can include System parameters (background system current, sensor use, IEGM storage, and remote monitoring) as well for more accurate results. We can model these along with Battery Capacity as independent normally distributed variables. We can calculate the total device current by summing the current values for each device and compute the PCI with the given information.  

### PCI MODEL

```{r}

#Pacing Current Function
p_current <- function(v, pw_ms, r_ohm, hr = 60, pace_fraction = 0.3){
  pw_sec <- pw_ms / 1000
  i_pulse <- v / r_ohm
  q <- i_pulse * pw_sec
  q_micro <- q * 1e6
  
  i_avg_microamps <- (q_micro * hr * pace_fraction) / 60
  return(i_avg_microamps)
}

#PCI + Longevity Function
long <- function(i_background, i_pacing, i_options, c_mah){
  c_uah <- c_mah * 1e3
  i_total <- i_background + i_pacing + i_options
  
  PCI <- i_total / c_uah
  long_hours <- 1 / PCI
  long_years <- long_hours / 8760
  
  return(list(
    i_total = i_total,
    PCI = PCI,
    years = long_years
  ))
}

```



### MC SIMULATION

#### 1) Simulation

```{r}
set.seed(400)
n_patients <- 100000

# Patient condition (indication)
condition <- sample(c("SND", "AVB"), n_patients, replace = TRUE, prob = c(0.6, 0.4))
hr <- pmin(pmax(rnorm(n_patients, 60, 5), 40), 90)

# Pacing percentages (as fractions 0-1)
ventricular_pacing <- ifelse(condition == "SND",
                            rnorm(n_patients, 0.29, 0.08),   # 29% ± 8% for SND
                            rnorm(n_patients, 0.90, 0.05))   # 90% ± 5% for AVB
ventricular_pacing <- pmin(pmax(ventricular_pacing, 0), 1)  # Clamp to 0-1

# Device parameters
c_mah <- pmax(rnorm(n_patients, 1000, 80), 800)        # Battery capacity
i_background <- pmax(rnorm(n_patients, 6.5, 0.7), 4)   # Background current

# Options current 
i_options <- rep(0, n_patients)  # Set to 0 to simplify

# Create patient data
sim_data <- tibble(
  id = 1:n_patients,
  condition,
  hr,
  ventricular_pacing,
  c_mah,
  i_background,
  i_options
)


```


#### 2) Base scenario (fixed impedance = 500Ω)


```{r}

sim_base <- sim_data %>%
  mutate(
    impedance = 500,
    i_pacing = p_current(2.5, 0.4, impedance, hr, ventricular_pacing),
    
    i_total = i_background + i_pacing + i_options,
    PCI = i_total / (c_mah * 1000),
    long_years = 1 / PCI / 8760,
    
    scenario = "Base (SD=0Ω)"
  )

```


#### 3) Extended scenario (variable lead impedance)


```{r}

sim_extended <- sim_data %>%
  mutate(
    impedance = pmax(rnorm(n_patients, 500, 100), 200),
    i_pacing = p_current(2.5, 0.4, impedance, hr, ventricular_pacing),
    
    i_total = i_background + i_pacing + i_options,
    PCI = i_total / (c_mah * 1000),
    long_years = 1 / PCI / 8760,
    
    scenario = "Extended (SD=100Ω)"
  )

```

#### 4) Summarize longevity distributions (table)




#### 5) Statistical test (t-test) to confirm significance



#### 6) Plot longevity distributions 



### DISCUSSION  



### CONCLUSION



