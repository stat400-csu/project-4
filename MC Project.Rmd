---
title: 'STAT 400 | Group 4 | Monte Carlo Simulation: CIED Longevity'
output:
  html_document: default
---


```{r setup, include=FALSE}
library(tidyverse)     
library(knitr)         
library(kableExtra)    

set.seed(400) 

```


## Article 

Cardiac implantable electronic devices’ longevity: A novel modelling tool for estimation and comparison  

## Project Overview

### Introduction

This project replicates and extends the Monte Carlo simulation from Defaye et al. (2025) on Cardiac Implantable Electronic Device (CIED) longevity. The original study introduced a Power Consumption Index (PCI) model to standardize battery life predictions across different pacemaker models and manufacturers.

### Research Goals
1. Replicate the PCI model and Monte Carlo simulation methodology

2. Extend the model by incorporating greater physiological variability in lead impedance

3. Compare device longevity predictions under base and extended scenarios

### Power Consumption Index Model

**Model Definition**

The core PCI model from the original study is defined as:

**PCI** = t × I / C

Where:


**t** = Time in minutes

**I** = Total current drain (µA)

**C** = Battery capacity (Ah)

### Methods: 

**Core Goal:** Test impedance variability effect on PCI predictions

**Simplified Patient Model:**
- 100,000 virtual patients
- Condition (SND/AVB), HR, ventricular pacing only
- Battery, background current, lead impedance

**Intentional Simplifications:**
- Excluded atrial parameters to focus on ventricular pacing
- Set optional features to zero for clarity
- Used single impedance value (not manufacturer-specific)

**Rationale:** Isolate effect of impedance variability while maintaining model essence

**Comparison:** Base (500Ω fixed) vs Extended (N(500,100)Ω)


### PCI MODEL

```{r}

#Pacing Current Function
p_current <- function(v, pw_ms, r_ohm, hr = 60, 
                      pace_fraction = 0.3){
  # Convert Pulse width to seconds
  pw_sec  <- pw_ms / 1000
  
  # Current during pulse
  i_pulse <- v / r_ohm
  
  # Charge per pulse in Coulombs
  q       <- i_pulse * pw_sec
  
  # Convert to microcoulombs
  q_micro <- q * 1e6
  
  # Average current over 1 minute
  i_avg_microamps <- (q_micro * hr * pace_fraction)/60
  return(i_avg_microamps)
}

#PCI + Longevity Function
long <- function(i_background, i_pacing, 
                 i_options, c_mah){
  # Convert battery capacity from mAh to µAh
  c_uah      <- c_mah * 1000
  # Total current in µA
  i_total    <- i_background + i_pacing + 
    i_options
  # Power Consumption Index (PCI)
  PCI        <- i_total / c_uah
  # Longevity in hours
  long_hours <- 1 / PCI
  # Longevity in years
  long_hours / 8760
  return(list(
    i_total = i_total,
    PCI = PCI,
    years = long_years))
  }

```



### MC SIMULATION

#### 1) Simulation

```{r}
set.seed(400)
n_patients <- 100000

# Patient condition (indication)
condition <- sample(c("SND", "AVB"), n_patients, replace = TRUE, prob = c(0.6, 0.4))
hr <- pmin(pmax(rnorm(n_patients, 60, 5), 40), 90)

# Pacing percentages (as fractions 0-1)
ventricular_pacing <- ifelse(condition == "SND",
                            rnorm(n_patients, 0.29, 0.08),   # 29% ± 8% for SND
                            rnorm(n_patients, 0.90, 0.05))   # 90% ± 5% for AVB
ventricular_pacing <- pmin(pmax(ventricular_pacing, 0), 1)  # Clamp to 0-1

# Device parameters
c_mah <- pmax(rnorm(n_patients, 1000, 80), 800)        # Battery capacity
i_background <- pmax(rnorm(n_patients, 6.5, 0.7), 4)   # Background current

# Options current 
i_options <- rep(0, n_patients)  # Set to 0 to simplify

# Create patient data
sim_data <- tibble(
  id = 1:n_patients,
  condition,
  hr,
  ventricular_pacing,
  c_mah,
  i_background,
  i_options
)


```


#### 2) Base scenario (fixed impedance = 500Ω)


```{r}

sim_base <- sim_data %>%
  mutate(
    impedance = 500,
    i_pacing = p_current(2.5, 0.4, impedance, hr, ventricular_pacing),
    i_total = i_background + i_pacing + i_options,
    PCI = i_total / (c_mah * 1000),
    long_years = 1 / PCI / 8760,
    scenario = "Base (500 Ohms)"
  )

```


#### 3) Extended scenario (variable lead impedance)


```{r}

sim_extended <- sim_data %>%
  mutate(
    impedance = pmax(rnorm(n_patients, 500, 100), 200),
    i_pacing = p_current(2.5, 0.4, impedance, hr, ventricular_pacing),
    i_total = i_background + i_pacing + i_options,
    PCI = i_total / (c_mah * 1000),
    long_years = 1 / PCI / 8760,
    scenario = "Extended (500 Ohms ± 100 Ohms)"
  )

```

#### 4) Summarize longevity distributions (table)

```{r}

results <- bind_rows(
  select(sim_base, id, condition, long_years, scenario),
  select(sim_extended, id, condition, long_years, scenario)
)

summary_tbl <- results %>%
  group_by(scenario) %>%
  summarise(
    mean_years = mean(long_years),
    median_years = median(long_years),
    sd_years = sd(long_years),
    q1 = quantile(long_years, 0.25),
    q3 = quantile(long_years, 0.75),
    n = n()
  )

# Summary table
summary_display <- summary_tbl %>%
  mutate(
    n = format(n, big.mark = ",", scientific = FALSE)  
  ) %>%
  rename(
    Scenario = scenario,
    Mean = mean_years,
    Median = median_years,
    SD = sd_years,
    Q1 = q1,
    Q3 = q3,
    N = n
  )

kable(summary_display, 
      digits = 2,
      align = c('l', rep('c', 6)))

```

#### 5) Statistical test (t-test) to confirm significance

```{r}
t_test_result <- t.test(
  filter(results, scenario == "Base (500 Ohms)")$long_years,
  filter(results, scenario == "Extended (500 Ohms ± 100 Ohms)")$long_years
)

print(t_test_result)

```


#### 6) Plot longevity distributions 

```{r}

ggplot(results, aes(x = long_years, fill = scenario)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("blue", "gold")) +
  labs(
    title = "CIED Longevity: Base vs Extended Impedance",
    x = "Longevity (years)",
    y = "Density",
    fill = "Scenario"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(color = "darkblue", face = "bold"),
    plot.subtitle = element_text(color = "gray40", size = 12),
    axis.title = element_text(color = "black")
  )

```


### DISCUSSION  

The goal of our project was to recreate the central modeling approach described in Defaye et al. (2025), which introduced the Power Consumption Index (PCI) as a standardized way for comparing cardiac implantable electronic device longevity. The original study relied on detailed manufacturer-reported current drain data to build the model, followed by a large-scale Monte Carlo Simulation of 100,000 patients. For our recreation, we reproduced the key steps in the study by generating 100,000 virtual patients with randomized physiological and device parameters, including heart rate, pacing percentages, battery capacity, background current, and lead impedance. Using these inputs, we calculated pacing current, total device current, PCI, and predicted device longevity.

Overall, we observed the following points that aligned with the original study:

#### 1. The background current dominates the total power consumption
In our simulation, patients with low pacing percentages had longevity largely determined by background current. In the original study, the majority of the PCI is driven by the background current, so our recreation aligned with this.

#### 2. The pacing burden substantially influences longevity
Our simulation shows that higher ventricular pacing percentages had higher total current and lower projected longevity. This aligns with the original study, where pacing current was the second-largest contributor to power consumption. 

#### 3. The battery capacity alone cannot predict longevity
Devices with higher battery capacity generally exhibited longer simulated service life. However, total current from background and pacing influences longevity as well, so battery size alone does not fully determine expected device lifespan, which aligns with the original study's findings.

#### 4. Lead impedance variability impacts longevity
When simulating variable lead impedance (Extended scenario), mean device longevity slightly decreased compared to the base scenario (fixed impedance). A t-test confirmed that the difference in mean longevity was statistically significant, demonstrating that lead characteristics can meaningfully affect outcomes in terms of longevity. 


### CONCLUSION

Our Monte Carlo model successfully recreated key elements of the PCI-based longevity estimation introduced by Defaye et al. (2025). Despite using fewer device-specific parameters and a simplified representation of programming options, our simulated findings closely reflected the patterns reported in the original study. These findings reinforce the use of the PCI as a standardized and adaptable framework for understanding and comparing device life under varying patient and device conditions.

The alignment of our simulation and the published results support the idea that even approximate PCI-based modeling can produce meaningful insights into device longevity. As in the original study, our results highlight meaningful practical implications. Even in a simplified form, our recreation demonstrates the impact and accuracy of the PCI model and shows the value it brings to real-world scenarios. 

